using System;
using System.Drawing;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace store_parts
{
    public partial class LoginForm : Form
    {
        /// <summary>
        /// Static property to track if the current user is logged in as admin
        /// </summary>
        public static bool IsAdmin { get; private set; } = false;

        /// <summary>
        /// Static property to store the current username
        /// </summary>
        public static string CurrentUser { get; private set; } = "";

        private Button btnConfigureDb;

        public LoginForm()
        {
            InitializeComponent();
            AddDatabaseConfigButton();
            this.Load += LoginForm_Load;
        }

        private void AddDatabaseConfigButton()
        {
            btnConfigureDb = new Button
            {
                Text = "Configure Database",
                Location = new Point(70, 520),
                Size = new Size(380, 45),
                FlatStyle = FlatStyle.Flat,
                BackColor = Color.FromArgb(52, 152, 219),
                ForeColor = Color.White,
                Font = new Font("Segoe UI", 11, FontStyle.Bold)
            };
            btnConfigureDb.FlatAppearance.BorderSize = 0;
            btnConfigureDb.Click += BtnConfigureDb_Click;
            
            // Add to panel2 (the right panel with login controls)
            if (this.panel2 != null)
            {
                this.panel2.Controls.Add(btnConfigureDb);
            }
            else
            {
                // Fallback if panel2 doesn't exist
                btnConfigureDb.Location = new Point(470, 520);
                this.Controls.Add(btnConfigureDb);
            }
        }

        private void LoginForm_Load(object sender, EventArgs e)
        {
            // Check database connection on startup
            CheckDatabaseConnection();
        }

        private void CheckDatabaseConnection()
        {
            lblStatus.Text = "Checking database connection...";
            lblStatus.ForeColor = Color.Blue;
            lblStatus.Visible = true;
            Application.DoEvents();

            bool connected = DatabaseHelper.TestConnection();

            if (connected)
            {
                lblStatus.Text = "Database connected";
                lblStatus.ForeColor = Color.Green;

                // Initialize database tables if needed
                DatabaseHelper.InitializeDatabase();
            }
            else
            {
                lblStatus.Text = "Database not configured. Click 'Configure Database' below.";
                lblStatus.ForeColor = Color.Orange;
            }
        }

        private void BtnConfigureDb_Click(object sender, EventArgs e)
        {
            using (DatabaseConfigForm configForm = new DatabaseConfigForm())
            {
                if (configForm.ShowDialog() == DialogResult.OK)
                {
                    CheckDatabaseConnection();
                    MessageBox.Show("Database configured successfully!", "Success",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
        }

        private async void btnLogin_Click(object sender, EventArgs e)
        {
            // Check database connection first
            if (!DatabaseHelper.TestConnection())
            {
                MessageBox.Show("Database is not connected.\n\nPlease click 'Configure Database' to set up the connection.",
                    "Database Not Connected", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            // Validate input
            if (string.IsNullOrWhiteSpace(txtUsername.Text))
            {
                MessageBox.Show("Please enter your username.", 
                    "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtUsername.Focus();
                return;
            }

            if (string.IsNullOrWhiteSpace(txtPassword.Text))
            {
                MessageBox.Show("Please enter your password.", 
                    "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtPassword.Focus();
                return;
            }

            // Disable controls during login
            SetControlsEnabled(false);
            lblStatus.Text = "Authenticating...";
            lblStatus.Visible = true;

            try
            {
                // Simulate async operation for smooth UI
                await Task.Delay(300);
                
                bool success = ValidateCredentials(txtUsername.Text, txtPassword.Text);

                if (success)
                {
                    lblStatus.Text = "Login successful!";
                    lblStatus.ForeColor = System.Drawing.Color.Green;
                    
                    // Wait a moment to show success message
                    await Task.Delay(500);
                    
                    // Hide login form and show main form
                    this.Hide();
                    Form1 mainForm = new Form1();
                    mainForm.FormClosed += (s, args) => this.Close();
                    mainForm.Show();
                }
                else
                {
                    lblStatus.Text = "Invalid username or password";
                    lblStatus.ForeColor = System.Drawing.Color.Red;
                    txtPassword.Clear();
                    txtPassword.Focus();
                    SetControlsEnabled(true);
                }
            }
            catch (Exception ex)
            {
                lblStatus.Text = "Login failed";
                lblStatus.ForeColor = System.Drawing.Color.Red;
                MessageBox.Show("An error occurred during login.\n\nError: " + ex.Message, 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                SetControlsEnabled(true);
            }
        }

        private bool ValidateCredentials(string username, string password)
        {
            // Reset admin status
            IsAdmin = false;
            CurrentUser = "";

            // Admin credentials: admin / admin
            if (username.ToLower() == "admin" && password == "admin")
            {
                IsAdmin = true;
                CurrentUser = "admin";
                return true;
            }
            
            // Original admin credentials
            if (username == "admin" && password == "Abhay@123")
            {
                IsAdmin = true;
                CurrentUser = "admin";
                return true;
            }
            
            // Regular user credentials
            if (username == "user" && password == "password")
            {
                IsAdmin = false;
                CurrentUser = "user";
                return true;
            }
            
            return false;
        }

        private void SetControlsEnabled(bool enabled)
        {
            txtUsername.Enabled = enabled;
            txtPassword.Enabled = enabled;
            btnLogin.Enabled = enabled;
            btnCancel.Enabled = enabled;
            btnConfigureDb.Enabled = enabled;
        }

        private void btnCancel_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Are you sure you want to exit?", 
                "Confirm Exit", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                Application.Exit();
            }
        }

        private void txtPassword_KeyPress(object sender, KeyPressEventArgs e)
        {
            // Allow Enter key to submit
            if (e.KeyChar == (char)Keys.Enter)
            {
                e.Handled = true;
                btnLogin_Click(sender, e);
            }
        }

        private void txtUsername_KeyPress(object sender, KeyPressEventArgs e)
        {
            // Allow Enter key to move to password
            if (e.KeyChar == (char)Keys.Enter)
            {
                e.Handled = true;
                txtPassword.Focus();
            }
        }

        private void LoginForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            // Cleanup if needed
        }

        private void chkShowPassword_CheckedChanged(object sender, EventArgs e)
        {
            txtPassword.UseSystemPasswordChar = !chkShowPassword.Checked;
        }

        private void panel1_Paint(object sender, PaintEventArgs e)
        {

        }

        private void lblSubtitle_Click(object sender, EventArgs e)
        {

        }
    }
}
