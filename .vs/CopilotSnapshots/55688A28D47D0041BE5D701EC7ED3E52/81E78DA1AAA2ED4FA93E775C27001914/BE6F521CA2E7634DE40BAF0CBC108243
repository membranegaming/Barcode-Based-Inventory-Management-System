using System;
using System.Data;
using System.Data.SqlClient;
using System.Windows.Forms;

namespace store_parts
{
    public partial class ShowTableForm : Form
    {
        public ShowTableForm()
        {
            InitializeComponent();
        }

        private void ShowTableForm_Load(object sender, EventArgs e)
        {
            try
            {
                // Ensure used_qty column exists in the DataTable schema BEFORE loading data
                EnsureUsedQtyColumn();
                
                // Load data with used_qty column
                LoadPartsData();
                
                // Handle remaining quantity calculation
                this.machinery_item_inward_unit2DataGridView.CellFormatting += DataGridView_CellFormatting;
                
                // Set default sort
                if (this.machinery_item_inward_unit2DataGridView.Columns["dataGridViewTextBoxColumn1"] != null)
                {
                    this.machinery_item_inward_unit2DataGridView.Sort(
                        this.machinery_item_inward_unit2DataGridView.Columns["dataGridViewTextBoxColumn1"], 
                        System.ComponentModel.ListSortDirection.Descending);
                }
                
                UpdateRecordCount();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error loading data: " + ex.Message, 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        /// <summary>
        /// Ensures the used_qty column exists in the DataTable schema
        /// </summary>
        private void EnsureUsedQtyColumn()
        {
            if (!this.mainDB.machinery_item_inward_unit2.Columns.Contains("used_qty"))
            {
                var col = new DataColumn("used_qty", typeof(int));
                col.DefaultValue = 0;
                col.AllowDBNull = true;
                this.mainDB.machinery_item_inward_unit2.Columns.Add(col);
            }
            
            // Also ensure party_outward_challan_no column exists if needed
            if (!this.mainDB.machinery_item_inward_unit2.Columns.Contains("party_outward_challan_no"))
            {
                var col = new DataColumn("party_outward_challan_no", typeof(string));
                col.DefaultValue = "";
                col.AllowDBNull = true;
                this.mainDB.machinery_item_inward_unit2.Columns.Add(col);
            }
        }

        private void LoadPartsData()
        {
            try
            {
                // Ensure columns exist before loading
                EnsureUsedQtyColumn();
                
                // Load data using direct SQL to include used_qty column
                string connectionString = global::store_parts.Properties.Settings.Default.MainDBConnectionString;
                
                using (SqlConnection connection = new SqlConnection(connectionString))
                {
                    // Check if party_outward_challan_no column exists in database
                    string sql = @"SELECT id, challan_no, date, party_name, item, qty, 
                                   ISNULL(used_qty, 0) as used_qty, reference_bill_no, bill_date, 
                                   ISNULL(party_outward_challan_no, '') as party_outward_challan_no,
                                   used_in_machine, taken_by 
                                   FROM machinery_item_inward_unit2
                                   ORDER BY id DESC";
                    
                    using (SqlDataAdapter adapter = new SqlDataAdapter(sql, connection))
                    {
                        this.mainDB.machinery_item_inward_unit2.Clear();
                        adapter.Fill(this.mainDB.machinery_item_inward_unit2);
                    }
                }
                
                // Accept changes to mark all rows as unchanged
                this.mainDB.machinery_item_inward_unit2.AcceptChanges();
            }
            catch (Exception ex)
            {
                // Fallback to TableAdapter if direct SQL fails
                System.Diagnostics.Debug.WriteLine("LoadPartsData fallback: " + ex.Message);
                try
                {
                    this.machinery_item_inward_unit2TableAdapter.Fill(this.mainDB.machinery_item_inward_unit2);
                    
                    // Set default values for used_qty if not present
                    foreach (DataRow row in this.mainDB.machinery_item_inward_unit2.Rows)
                    {
                        if (row.Table.Columns.Contains("used_qty") && row["used_qty"] == DBNull.Value)
                        {
                            row["used_qty"] = 0;
                        }
                    }
                    this.mainDB.machinery_item_inward_unit2.AcceptChanges();
                }
                catch (Exception innerEx)
                {
                    System.Diagnostics.Debug.WriteLine("LoadPartsData fallback also failed: " + innerEx.Message);
                }
            }
        }

        private void DataGridView_CellFormatting(object sender, DataGridViewCellFormattingEventArgs e)
        {
            // Calculate and display remaining quantity
            if (this.machinery_item_inward_unit2DataGridView.Columns[e.ColumnIndex].Name == "colRemainingQty")
            {
                if (e.RowIndex >= 0)
                {
                    DataGridViewRow row = this.machinery_item_inward_unit2DataGridView.Rows[e.RowIndex];
                    
                    int totalQty = 0;
                    int usedQty = 0;
                    
                    var qtyCell = row.Cells["dataGridViewTextBoxColumn6"];
                    var usedQtyCell = row.Cells["colUsedQty"];
                    
                    if (qtyCell != null && qtyCell.Value != null && qtyCell.Value != DBNull.Value)
                    {
                        int.TryParse(qtyCell.Value.ToString(), out totalQty);
                    }
                    
                    if (usedQtyCell != null && usedQtyCell.Value != null && usedQtyCell.Value != DBNull.Value)
                    {
                        int.TryParse(usedQtyCell.Value.ToString(), out usedQty);
                    }
                    
                    int remaining = totalQty - usedQty;
                    e.Value = remaining;
                    
                    // Color code based on remaining quantity
                    if (remaining <= 0)
                    {
                        e.CellStyle.ForeColor = System.Drawing.Color.Red;
                        e.CellStyle.Font = new System.Drawing.Font(e.CellStyle.Font, System.Drawing.FontStyle.Bold);
                    }
                    else if (remaining < totalQty)
                    {
                        e.CellStyle.ForeColor = System.Drawing.Color.Orange;
                    }
                    else
                    {
                        e.CellStyle.ForeColor = System.Drawing.Color.Green;
                    }
                }
            }
            
            // Color code used qty column
            if (this.machinery_item_inward_unit2DataGridView.Columns[e.ColumnIndex].Name == "colUsedQty")
            {
                if (e.RowIndex >= 0 && e.Value != null && e.Value != DBNull.Value)
                {
                    int usedQty = 0;
                    int.TryParse(e.Value.ToString(), out usedQty);
                    
                    if (usedQty > 0)
                    {
                        e.CellStyle.ForeColor = System.Drawing.Color.Blue;
                        e.CellStyle.Font = new System.Drawing.Font(e.CellStyle.Font, System.Drawing.FontStyle.Bold);
                    }
                }
            }
        }

        private void btnRefresh_Click(object sender, EventArgs e)
        {
            try
            {
                // Reload data from database
                LoadPartsData();
                UpdateRecordCount();
                
                MessageBox.Show("Data refreshed successfully!", 
                    "Refresh", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error refreshing data: " + ex.Message, 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnSearch_Click(object sender, EventArgs e)
        {
            try
            {
                string searchText = txtSearch.Text.Trim();
                
                if (string.IsNullOrEmpty(searchText))
                {
                    // Clear filter
                    this.machinery_item_inward_unit2BindingSource.RemoveFilter();
                }
                else
                {
                    // Apply filter to search across multiple columns
                    string filter = string.Format(
                        "challan_no LIKE '%{0}%' OR " +
                        "party_name LIKE '%{0}%' OR " +
                        "item LIKE '%{0}%' OR " +
                        "reference_bill_no LIKE '%{0}%' OR " +
                        "used_in_machine LIKE '%{0}%' OR " +
                        "taken_by LIKE '%{0}%'",
                        searchText.Replace("'", "''"));
                    
                    this.machinery_item_inward_unit2BindingSource.Filter = filter;
                }
                
                UpdateRecordCount();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error searching: " + ex.Message, 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnClearSearch_Click(object sender, EventArgs e)
        {
            txtSearch.Clear();
            this.machinery_item_inward_unit2BindingSource.RemoveFilter();
            UpdateRecordCount();
        }

        private void btnDelete_Click(object sender, EventArgs e)
        {
            try
            {
                if (this.machinery_item_inward_unit2DataGridView.SelectedRows.Count == 0)
                {
                    MessageBox.Show("Please select a row to delete.", 
                        "No Selection", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                DialogResult result = MessageBox.Show(
                    "Are you sure you want to delete the selected record(s)?", 
                    "Confirm Delete", 
                    MessageBoxButtons.YesNo, 
                    MessageBoxIcon.Question);

                if (result == DialogResult.Yes)
                {
                    string connectionString = global::store_parts.Properties.Settings.Default.MainDBConnectionString;
                    int deletedCount = 0;
                    
                    using (SqlConnection connection = new SqlConnection(connectionString))
                    {
                        connection.Open();
                        
                        foreach (DataGridViewRow row in this.machinery_item_inward_unit2DataGridView.SelectedRows)
                        {
                            if (!row.IsNewRow)
                            {
                                var idCell = row.Cells["dataGridViewTextBoxColumn1"];
                                if (idCell != null && idCell.Value != null)
                                {
                                    int id = Convert.ToInt32(idCell.Value);
                                    
                                    string sql = "DELETE FROM machinery_item_inward_unit2 WHERE id = @id";
                                    using (SqlCommand command = new SqlCommand(sql, connection))
                                    {
                                        command.Parameters.AddWithValue("@id", id);
                                        deletedCount += command.ExecuteNonQuery();
                                    }
                                }
                            }
                        }
                    }
                    
                    if (deletedCount > 0)
                    {
                        LoadPartsData();
                        UpdateRecordCount();
                        
                        MessageBox.Show(string.Format("{0} record(s) deleted successfully!", deletedCount), 
                            "Success", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error deleting record: " + ex.Message, 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnExportCSV_Click(object sender, EventArgs e)
        {
            try
            {
                SaveFileDialog saveFileDialog = new SaveFileDialog();
                saveFileDialog.Filter = "CSV files (*.csv)|*.csv|All files (*.*)|*.*";
                saveFileDialog.FilterIndex = 1;
                saveFileDialog.RestoreDirectory = true;
                saveFileDialog.FileName = "machinery_parts_" + DateTime.Now.ToString("yyyyMMdd_HHmmss") + ".csv";

                if (saveFileDialog.ShowDialog() == DialogResult.OK)
                {
                    System.Text.StringBuilder sb = new System.Text.StringBuilder();

                    // Add column headers
                    for (int i = 0; i < machinery_item_inward_unit2DataGridView.Columns.Count; i++)
                    {
                        if (machinery_item_inward_unit2DataGridView.Columns[i].Visible)
                        {
                            sb.Append("\"" + machinery_item_inward_unit2DataGridView.Columns[i].HeaderText.Replace("\"", "\"\"") + "\"");
                            if (i < machinery_item_inward_unit2DataGridView.Columns.Count - 1)
                                sb.Append(",");
                        }
                    }
                    sb.AppendLine();

                    // Add rows
                    foreach (DataGridViewRow row in machinery_item_inward_unit2DataGridView.Rows)
                    {
                        if (!row.IsNewRow)
                        {
                            for (int i = 0; i < machinery_item_inward_unit2DataGridView.Columns.Count; i++)
                            {
                                if (machinery_item_inward_unit2DataGridView.Columns[i].Visible)
                                {
                                    object cellValue = row.Cells[i].Value;
                                    
                                    // For Remaining column, calculate the value
                                    if (machinery_item_inward_unit2DataGridView.Columns[i].Name == "colRemainingQty")
                                    {
                                        int totalQty = 0;
                                        int usedQty = 0;
                                        
                                        var qtyCell = row.Cells["dataGridViewTextBoxColumn6"];
                                        var usedQtyCell = row.Cells["colUsedQty"];
                                        
                                        if (qtyCell != null && qtyCell.Value != null && qtyCell.Value != DBNull.Value)
                                            int.TryParse(qtyCell.Value.ToString(), out totalQty);
                                        if (usedQtyCell != null && usedQtyCell.Value != null && usedQtyCell.Value != DBNull.Value)
                                            int.TryParse(usedQtyCell.Value.ToString(), out usedQty);
                                        
                                        cellValue = totalQty - usedQty;
                                    }
                                    
                                    if (cellValue != null)
                                    {
                                        string value = cellValue.ToString().Replace("\"", "\"\"");
                                        sb.Append("\"" + value + "\"");
                                    }
                                    else
                                    {
                                        sb.Append("\"\"");
                                    }
                                    
                                    if (i < machinery_item_inward_unit2DataGridView.Columns.Count - 1)
                                        sb.Append(",");
                                }
                            }
                            sb.AppendLine();
                        }
                    }

                    System.IO.File.WriteAllText(saveFileDialog.FileName, sb.ToString(), System.Text.Encoding.UTF8);
                    
                    MessageBox.Show("Data exported successfully to:\n" + saveFileDialog.FileName, 
                        "Export Success", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error exporting data: " + ex.Message, 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnClose_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        private void UpdateRecordCount()
        {
            int totalRecords = this.machinery_item_inward_unit2BindingSource.Count;
            lblRecordCount.Text = string.Format("Total Records: {0}", totalRecords);
        }

        private void txtSearch_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (e.KeyChar == (char)Keys.Enter)
            {
                btnSearch_Click(sender, e);
                e.Handled = true;
            }
        }

        private void machinery_item_inward_unit2DataGridView_CellDoubleClick(object sender, DataGridViewCellEventArgs e)
        {
            // Reserved for future editing functionality
        }
    }
}
