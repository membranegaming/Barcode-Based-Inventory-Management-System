using System;
using System.Data;
using System.Data.SqlClient;
using System.Drawing;
using System.Windows.Forms;

namespace store_parts
{
    /// <summary>
    /// Admin form for searching and modifying any entry in the database
    /// </summary>
    public partial class AdminEditForm : Form
    {
        private DataTable _dataTable;
        private int _selectedId = -1;

        // Controls
        private TextBox txtSearch;
        private ComboBox cmbSearchField;
        private Button btnSearch;
        private Button btnClearSearch;
        private DataGridView dataGridView;
        private GroupBox grpEdit;
        private TextBox txtId;
        private TextBox txtChallanNo;
        private DateTimePicker dtpDate;
        private ComboBox cmbPartyName;
        private ComboBox cmbItem;
        private TextBox txtQty;
        private TextBox txtUsedQty;
        private TextBox txtRefBillNo;
        private DateTimePicker dtpBillDate;
        private ComboBox cmbMachine;
        private ComboBox cmbTakenBy;
        private Button btnSave;
        private Button btnDelete;
        private Button btnClear;
        private Label lblStatus;

        public AdminEditForm()
        {
            InitializeComponent();
            LoadData();
            LoadComboBoxData();
        }

        private void InitializeComponent()
        {
            this.Text = "Admin - Edit Entries";
            this.Size = new Size(1300, 750);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.BackColor = Color.FromArgb(240, 240, 245);
            this.Font = new Font("Segoe UI", 9);

            // Title
            Label lblTitle = new Label
            {
                Text = "🔧 Admin Panel - Modify Entries",
                Font = new Font("Segoe UI", 16, FontStyle.Bold),
                ForeColor = Color.FromArgb(50, 50, 50),
                Location = new Point(20, 15),
                AutoSize = true
            };
            this.Controls.Add(lblTitle);

            // Search Panel
            Panel searchPanel = new Panel
            {
                Location = new Point(20, 55),
                Size = new Size(1240, 50),
                BackColor = Color.White,
                BorderStyle = BorderStyle.FixedSingle
            };

            Label lblSearchBy = new Label
            {
                Text = "Search By:",
                Location = new Point(10, 15),
                AutoSize = true
            };
            searchPanel.Controls.Add(lblSearchBy);

            cmbSearchField = new ComboBox
            {
                Location = new Point(85, 12),
                Size = new Size(150, 25),
                DropDownStyle = ComboBoxStyle.DropDownList
            };
            cmbSearchField.Items.AddRange(new object[] { "ID", "Challan No", "Party Name", "Item", "Machine", "Taken By" });
            cmbSearchField.SelectedIndex = 0;
            searchPanel.Controls.Add(cmbSearchField);

            txtSearch = new TextBox
            {
                Location = new Point(250, 12),
                Size = new Size(300, 25),
                Font = new Font("Segoe UI", 10)
            };
            txtSearch.KeyPress += TxtSearch_KeyPress;
            searchPanel.Controls.Add(txtSearch);

            btnSearch = new Button
            {
                Text = "🔍 Search",
                Location = new Point(565, 10),
                Size = new Size(100, 30),
                BackColor = Color.FromArgb(0, 122, 204),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            btnSearch.Click += BtnSearch_Click;
            searchPanel.Controls.Add(btnSearch);

            btnClearSearch = new Button
            {
                Text = "Clear",
                Location = new Point(675, 10),
                Size = new Size(80, 30),
                FlatStyle = FlatStyle.Flat
            };
            btnClearSearch.Click += BtnClearSearch_Click;
            searchPanel.Controls.Add(btnClearSearch);

            lblStatus = new Label
            {
                Text = "Total Records: 0",
                Location = new Point(800, 15),
                AutoSize = true,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            searchPanel.Controls.Add(lblStatus);

            this.Controls.Add(searchPanel);

            // DataGridView
            dataGridView = new DataGridView
            {
                Location = new Point(20, 115),
                Size = new Size(900, 350),
                BackgroundColor = Color.White,
                BorderStyle = BorderStyle.FixedSingle,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                AllowUserToAddRows = false,
                AllowUserToDeleteRows = false,
                ReadOnly = true,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect,
                RowHeadersVisible = false,
                MultiSelect = false
            };
            dataGridView.SelectionChanged += DataGridView_SelectionChanged;
            dataGridView.CellDoubleClick += DataGridView_CellDoubleClick;
            this.Controls.Add(dataGridView);

            // Edit Panel
            grpEdit = new GroupBox
            {
                Text = "Edit Entry",
                Location = new Point(930, 115),
                Size = new Size(330, 570),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            int y = 30;
            int labelWidth = 100;
            int controlWidth = 200;
            int spacing = 40;

            // ID (Read-only)
            AddLabelAndControl(grpEdit, "ID:", ref y, labelWidth, out Label lblId);
            txtId = new TextBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                ReadOnly = true,
                BackColor = Color.LightGray,
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(txtId);
            y += spacing;

            // Challan No
            AddLabelAndControl(grpEdit, "Challan No:", ref y, labelWidth, out Label lblChallan);
            txtChallanNo = new TextBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(txtChallanNo);
            y += spacing;

            // Date
            AddLabelAndControl(grpEdit, "Date:", ref y, labelWidth, out Label lblDate);
            dtpDate = new DateTimePicker
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                Format = DateTimePickerFormat.Short
            };
            grpEdit.Controls.Add(dtpDate);
            y += spacing;

            // Party Name
            AddLabelAndControl(grpEdit, "Party Name:", ref y, labelWidth, out Label lblParty);
            cmbPartyName = new ComboBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                DropDownStyle = ComboBoxStyle.DropDown,
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(cmbPartyName);
            y += spacing;

            // Item
            AddLabelAndControl(grpEdit, "Item:", ref y, labelWidth, out Label lblItem);
            cmbItem = new ComboBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                DropDownStyle = ComboBoxStyle.DropDown,
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(cmbItem);
            y += spacing;

            // Qty
            AddLabelAndControl(grpEdit, "Total Qty:", ref y, labelWidth, out Label lblQty);
            txtQty = new TextBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(txtQty);
            y += spacing;

            // Used Qty
            AddLabelAndControl(grpEdit, "Used Qty:", ref y, labelWidth, out Label lblUsedQty);
            txtUsedQty = new TextBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(txtUsedQty);
            y += spacing;

            // Reference Bill No
            AddLabelAndControl(grpEdit, "Ref Bill No:", ref y, labelWidth, out Label lblRefBill);
            txtRefBillNo = new TextBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(txtRefBillNo);
            y += spacing;

            // Bill Date
            AddLabelAndControl(grpEdit, "Bill Date:", ref y, labelWidth, out Label lblBillDate);
            dtpBillDate = new DateTimePicker
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                Format = DateTimePickerFormat.Short
            };
            grpEdit.Controls.Add(dtpBillDate);
            y += spacing;

            // Machine
            AddLabelAndControl(grpEdit, "Machine:", ref y, labelWidth, out Label lblMachine);
            cmbMachine = new ComboBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                DropDownStyle = ComboBoxStyle.DropDown,
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(cmbMachine);
            y += spacing;

            // Taken By
            AddLabelAndControl(grpEdit, "Taken By:", ref y, labelWidth, out Label lblTakenBy);
            cmbTakenBy = new ComboBox
            {
                Location = new Point(110, y - 5),
                Size = new Size(controlWidth, 25),
                DropDownStyle = ComboBoxStyle.DropDown,
                Font = new Font("Segoe UI", 9)
            };
            grpEdit.Controls.Add(cmbTakenBy);
            y += spacing + 10;

            // Buttons
            btnSave = new Button
            {
                Text = "💾 Save Changes",
                Location = new Point(15, y),
                Size = new Size(145, 35),
                BackColor = Color.FromArgb(46, 204, 113),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnSave.Click += BtnSave_Click;
            grpEdit.Controls.Add(btnSave);

            btnDelete = new Button
            {
                Text = "🗑️ Delete",
                Location = new Point(165, y),
                Size = new Size(145, 35),
                BackColor = Color.FromArgb(231, 76, 60),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };
            btnDelete.Click += BtnDelete_Click;
            grpEdit.Controls.Add(btnDelete);

            y += 45;

            btnClear = new Button
            {
                Text = "Clear Form",
                Location = new Point(15, y),
                Size = new Size(295, 30),
                FlatStyle = FlatStyle.Flat
            };
            btnClear.Click += BtnClear_Click;
            grpEdit.Controls.Add(btnClear);

            this.Controls.Add(grpEdit);

            // Close button
            Button btnClose = new Button
            {
                Text = "Close",
                Location = new Point(1150, 15),
                Size = new Size(100, 30),
                FlatStyle = FlatStyle.Flat
            };
            btnClose.Click += (s, e) => this.Close();
            this.Controls.Add(btnClose);
        }

        private void AddLabelAndControl(GroupBox parent, string text, ref int y, int labelWidth, out Label label)
        {
            label = new Label
            {
                Text = text,
                Location = new Point(15, y),
                Size = new Size(labelWidth, 20),
                Font = new Font("Segoe UI", 9),
                TextAlign = ContentAlignment.MiddleRight
            };
            parent.Controls.Add(label);
        }

        private string GetConnectionString()
        {
            return global::store_parts.Properties.Settings.Default.MainDBConnectionString;
        }

        private void LoadData()
        {
            try
            {
                using (SqlConnection connection = new SqlConnection(GetConnectionString()))
                {
                    string sql = @"SELECT id as ID, challan_no as [Challan No], date as [Date], 
                                   party_name as [Party Name], item as Item, qty as [Total Qty], 
                                   ISNULL(used_qty, 0) as [Used Qty], 
                                   reference_bill_no as [Ref Bill No], bill_date as [Bill Date],
                                   ISNULL(used_in_machine, '') as Machine, 
                                   ISNULL(taken_by, '') as [Taken By]
                                   FROM machinery_item_inward_unit2 
                                   ORDER BY id DESC";

                    using (SqlDataAdapter adapter = new SqlDataAdapter(sql, connection))
                    {
                        _dataTable = new DataTable();
                        adapter.Fill(_dataTable);
                        dataGridView.DataSource = _dataTable;
                        UpdateStatus();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error loading data: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void LoadComboBoxData()
        {
            try
            {
                using (SqlConnection connection = new SqlConnection(GetConnectionString()))
                {
                    connection.Open();

                    // Load Party Names
                    using (SqlCommand cmd = new SqlCommand("SELECT DISTINCT party_name FROM PartyMaster WHERE is_active = 1", connection))
                    {
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                cmbPartyName.Items.Add(reader["party_name"].ToString());
                            }
                        }
                    }

                    // Load Items
                    using (SqlCommand cmd = new SqlCommand("SELECT DISTINCT item_name FROM ItemMaster WHERE is_active = 1", connection))
                    {
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                cmbItem.Items.Add(reader["item_name"].ToString());
                            }
                        }
                    }

                    // Load Machines
                    cmbMachine.Items.Add("");
                    using (SqlCommand cmd = new SqlCommand("SELECT DISTINCT machine_name FROM MachineMaster WHERE is_active = 1", connection))
                    {
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                cmbMachine.Items.Add(reader["machine_name"].ToString());
                            }
                        }
                    }

                    // Load Persons
                    cmbTakenBy.Items.Add("");
                    using (SqlCommand cmd = new SqlCommand("SELECT DISTINCT person_name FROM PersonMaster WHERE is_active = 1", connection))
                    {
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                cmbTakenBy.Items.Add(reader["person_name"].ToString());
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Error loading combo data: " + ex.Message);
            }
        }

        private void UpdateStatus()
        {
            lblStatus.Text = $"Total Records: {_dataTable?.Rows.Count ?? 0}";
        }

        private void TxtSearch_KeyPress(object sender, KeyPressEventArgs e)
        {
            if (e.KeyChar == (char)Keys.Enter)
            {
                e.Handled = true;
                BtnSearch_Click(sender, e);
            }
        }

        private void BtnSearch_Click(object sender, EventArgs e)
        {
            try
            {
                string searchText = txtSearch.Text.Trim();
                string searchField = cmbSearchField.SelectedItem.ToString();

                if (string.IsNullOrEmpty(searchText))
                {
                    LoadData();
                    return;
                }

                string columnName = "";
                switch (searchField)
                {
                    case "ID":
                        columnName = "id";
                        break;
                    case "Challan No":
                        columnName = "challan_no";
                        break;
                    case "Party Name":
                        columnName = "party_name";
                        break;
                    case "Item":
                        columnName = "item";
                        break;
                    case "Machine":
                        columnName = "used_in_machine";
                        break;
                    case "Taken By":
                        columnName = "taken_by";
                        break;
                }

                using (SqlConnection connection = new SqlConnection(GetConnectionString()))
                {
                    string sql;
                    if (searchField == "ID")
                    {
                        sql = $@"SELECT id as ID, challan_no as [Challan No], date as [Date], 
                                party_name as [Party Name], item as Item, qty as [Total Qty], 
                                ISNULL(used_qty, 0) as [Used Qty], 
                                reference_bill_no as [Ref Bill No], bill_date as [Bill Date],
                                ISNULL(used_in_machine, '') as Machine, 
                                ISNULL(taken_by, '') as [Taken By]
                                FROM machinery_item_inward_unit2 
                                WHERE {columnName} = @search
                                ORDER BY id DESC";
                    }
                    else
                    {
                        sql = $@"SELECT id as ID, challan_no as [Challan No], date as [Date], 
                                party_name as [Party Name], item as Item, qty as [Total Qty], 
                                ISNULL(used_qty, 0) as [Used Qty], 
                                reference_bill_no as [Ref Bill No], bill_date as [Bill Date],
                                ISNULL(used_in_machine, '') as Machine, 
                                ISNULL(taken_by, '') as [Taken By]
                                FROM machinery_item_inward_unit2 
                                WHERE {columnName} LIKE @search
                                ORDER BY id DESC";
                    }

                    using (SqlCommand cmd = new SqlCommand(sql, connection))
                    {
                        if (searchField == "ID")
                        {
                            int id;
                            if (int.TryParse(searchText, out id))
                                cmd.Parameters.AddWithValue("@search", id);
                            else
                            {
                                MessageBox.Show("Please enter a valid numeric ID.", "Invalid Input", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                                return;
                            }
                        }
                        else
                        {
                            cmd.Parameters.AddWithValue("@search", "%" + searchText + "%");
                        }

                        using (SqlDataAdapter adapter = new SqlDataAdapter(cmd))
                        {
                            _dataTable = new DataTable();
                            adapter.Fill(_dataTable);
                            dataGridView.DataSource = _dataTable;
                            UpdateStatus();
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Search error: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void BtnClearSearch_Click(object sender, EventArgs e)
        {
            txtSearch.Clear();
            cmbSearchField.SelectedIndex = 0;
            LoadData();
        }

        private void DataGridView_SelectionChanged(object sender, EventArgs e)
        {
            if (dataGridView.SelectedRows.Count > 0)
            {
                LoadSelectedRow();
            }
        }

        private void DataGridView_CellDoubleClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex >= 0)
            {
                LoadSelectedRow();
            }
        }

        private void LoadSelectedRow()
        {
            try
            {
                if (dataGridView.SelectedRows.Count == 0) return;

                DataGridViewRow row = dataGridView.SelectedRows[0];
                _selectedId = Convert.ToInt32(row.Cells["ID"].Value);

                txtId.Text = row.Cells["ID"].Value.ToString();
                txtChallanNo.Text = row.Cells["Challan No"].Value?.ToString() ?? "";
                dtpDate.Value = row.Cells["Date"].Value != DBNull.Value ? Convert.ToDateTime(row.Cells["Date"].Value) : DateTime.Today;
                cmbPartyName.Text = row.Cells["Party Name"].Value?.ToString() ?? "";
                cmbItem.Text = row.Cells["Item"].Value?.ToString() ?? "";
                txtQty.Text = row.Cells["Total Qty"].Value?.ToString() ?? "0";
                txtUsedQty.Text = row.Cells["Used Qty"].Value?.ToString() ?? "0";
                txtRefBillNo.Text = row.Cells["Ref Bill No"].Value?.ToString() ?? "";
                dtpBillDate.Value = row.Cells["Bill Date"].Value != DBNull.Value ? Convert.ToDateTime(row.Cells["Bill Date"].Value) : DateTime.Today;
                cmbMachine.Text = row.Cells["Machine"].Value?.ToString() ?? "";
                cmbTakenBy.Text = row.Cells["Taken By"].Value?.ToString() ?? "";
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Error loading row: " + ex.Message);
            }
        }

        private void BtnSave_Click(object sender, EventArgs e)
        {
            if (_selectedId <= 0)
            {
                MessageBox.Show("Please select a record to edit.", "No Selection", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            // Validate
            if (string.IsNullOrWhiteSpace(txtChallanNo.Text))
            {
                MessageBox.Show("Challan No is required.", "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtChallanNo.Focus();
                return;
            }

            int qty, usedQty;
            if (!int.TryParse(txtQty.Text, out qty) || qty < 0)
            {
                MessageBox.Show("Please enter a valid quantity.", "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtQty.Focus();
                return;
            }

            if (!int.TryParse(txtUsedQty.Text, out usedQty) || usedQty < 0)
            {
                MessageBox.Show("Please enter a valid used quantity.", "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtUsedQty.Focus();
                return;
            }

            if (usedQty > qty)
            {
                MessageBox.Show("Used quantity cannot be greater than total quantity.", "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtUsedQty.Focus();
                return;
            }

            try
            {
                using (SqlConnection connection = new SqlConnection(GetConnectionString()))
                {
                    string sql = @"UPDATE machinery_item_inward_unit2 
                                   SET challan_no = @challan_no,
                                       date = @date,
                                       party_name = @party_name,
                                       item = @item,
                                       qty = @qty,
                                       used_qty = @used_qty,
                                       reference_bill_no = @ref_bill_no,
                                       bill_date = @bill_date,
                                       used_in_machine = @machine,
                                       taken_by = @taken_by
                                   WHERE id = @id";

                    using (SqlCommand cmd = new SqlCommand(sql, connection))
                    {
                        cmd.Parameters.AddWithValue("@id", _selectedId);
                        cmd.Parameters.AddWithValue("@challan_no", txtChallanNo.Text.Trim());
                        cmd.Parameters.AddWithValue("@date", dtpDate.Value.Date);
                        cmd.Parameters.AddWithValue("@party_name", cmbPartyName.Text);
                        cmd.Parameters.AddWithValue("@item", cmbItem.Text);
                        cmd.Parameters.AddWithValue("@qty", qty);
                        cmd.Parameters.AddWithValue("@used_qty", usedQty);
                        cmd.Parameters.AddWithValue("@ref_bill_no", string.IsNullOrEmpty(txtRefBillNo.Text) ? (object)DBNull.Value : txtRefBillNo.Text.Trim());
                        cmd.Parameters.AddWithValue("@bill_date", dtpBillDate.Value.Date);
                        cmd.Parameters.AddWithValue("@machine", cmbMachine.Text ?? "");
                        cmd.Parameters.AddWithValue("@taken_by", cmbTakenBy.Text ?? "");

                        connection.Open();
                        int affected = cmd.ExecuteNonQuery();

                        if (affected > 0)
                        {
                            MessageBox.Show($"Record ID {_selectedId} updated successfully!", "Success", MessageBoxButtons.OK, MessageBoxIcon.Information);
                            LoadData();
                        }
                        else
                        {
                            MessageBox.Show("No changes were saved.", "Warning", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error saving changes: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void BtnDelete_Click(object sender, EventArgs e)
        {
            if (_selectedId <= 0)
            {
                MessageBox.Show("Please select a record to delete.", "No Selection", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            DialogResult result = MessageBox.Show(
                $"Are you sure you want to permanently delete record ID {_selectedId}?\n\nThis action cannot be undone!",
                "Confirm Delete",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning,
                MessageBoxDefaultButton.Button2);

            if (result != DialogResult.Yes) return;

            try
            {
                using (SqlConnection connection = new SqlConnection(GetConnectionString()))
                {
                    string sql = "DELETE FROM machinery_item_inward_unit2 WHERE id = @id";

                    using (SqlCommand cmd = new SqlCommand(sql, connection))
                    {
                        cmd.Parameters.AddWithValue("@id", _selectedId);
                        connection.Open();
                        int affected = cmd.ExecuteNonQuery();

                        if (affected > 0)
                        {
                            MessageBox.Show($"Record ID {_selectedId} deleted successfully!", "Deleted", MessageBoxButtons.OK, MessageBoxIcon.Information);
                            BtnClear_Click(sender, e);
                            LoadData();
                        }
                        else
                        {
                            MessageBox.Show("Record not found or already deleted.", "Warning", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error deleting record: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void BtnClear_Click(object sender, EventArgs e)
        {
            _selectedId = -1;
            txtId.Clear();
            txtChallanNo.Clear();
            dtpDate.Value = DateTime.Today;
            cmbPartyName.SelectedIndex = -1;
            cmbPartyName.Text = "";
            cmbItem.SelectedIndex = -1;
            cmbItem.Text = "";
            txtQty.Clear();
            txtUsedQty.Clear();
            txtRefBillNo.Clear();
            dtpBillDate.Value = DateTime.Today;
            cmbMachine.SelectedIndex = -1;
            cmbMachine.Text = "";
            cmbTakenBy.SelectedIndex = -1;
            cmbTakenBy.Text = "";
            dataGridView.ClearSelection();
        }
    }
}
