using System;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using Newtonsoft.Json;

namespace store_parts
{
    public partial class LoginForm : Form
    {
        private const string API_URL = "https://baalarauth.vercel.app/api/login";
        private HttpClient httpClient;

        public LoginForm()
        {
            InitializeComponent();
            httpClient = new HttpClient();
            httpClient.Timeout = TimeSpan.FromSeconds(10);
        }

        private async void btnLogin_Click(object sender, EventArgs e)
        {
            // Validate input
            if (string.IsNullOrWhiteSpace(txtUsername.Text))
            {
                MessageBox.Show("Please enter your username.", 
                    "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtUsername.Focus();
                return;
            }

            if (string.IsNullOrWhiteSpace(txtPassword.Text))
            {
                MessageBox.Show("Please enter your password.", 
                    "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtPassword.Focus();
                return;
            }

            // Disable controls during login
            SetControlsEnabled(false);
            lblStatus.Text = "Authenticating...";
            lblStatus.Visible = true;

            try
            {
                bool success = await LoginAsync(txtUsername.Text, txtPassword.Text);

                if (success)
                {
                    lblStatus.Text = "Login successful!";
                    lblStatus.ForeColor = System.Drawing.Color.Green;
                    
                    // Wait a moment to show success message
                    await Task.Delay(500);
                    
                    // Hide login form and show main form
                    this.Hide();
                    Form1 mainForm = new Form1();
                    mainForm.FormClosed += (s, args) => this.Close();
                    mainForm.Show();
                }
                else
                {
                    lblStatus.Text = "Invalid username or password";
                    lblStatus.ForeColor = System.Drawing.Color.Red;
                    txtPassword.Clear();
                    txtPassword.Focus();
                    SetControlsEnabled(true);
                }
            }
            catch (HttpRequestException ex)
            {
                lblStatus.Text = "Connection error";
                lblStatus.ForeColor = System.Drawing.Color.Red;
                MessageBox.Show("Unable to connect to authentication server.\n\nError: " + ex.Message, 
                    "Connection Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                SetControlsEnabled(true);
            }
            catch (TaskCanceledException)
            {
                lblStatus.Text = "Request timeout";
                lblStatus.ForeColor = System.Drawing.Color.Red;
                MessageBox.Show("The authentication request timed out. Please check your internet connection.", 
                    "Timeout Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                SetControlsEnabled(true);
            }
            catch (Exception ex)
            {
                lblStatus.Text = "Login failed";
                lblStatus.ForeColor = System.Drawing.Color.Red;
                MessageBox.Show("An error occurred during login.\n\nError: " + ex.Message, 
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                SetControlsEnabled(true);
            }
        }

        private async Task<bool> LoginAsync(string username, string password)
        {
            try
            {
                var requestBody = new
                {
                    username = username,
                    password = password
                };

                var json = JsonConvert.SerializeObject(requestBody);
                var content = new StringContent(json, Encoding.UTF8, "application/json");

                var response = await httpClient.PostAsync(API_URL, content);
                var responseContent = await response.Content.ReadAsStringAsync();

                // Check if response is successful
                if (!response.IsSuccessStatusCode)
                {
                    throw new Exception($"Server returned error: {response.StatusCode}");
                }

                // Check if response content is valid JSON
                if (string.IsNullOrWhiteSpace(responseContent) || 
                    responseContent.TrimStart()[0] != '{')
                {
                    throw new Exception("Invalid response from server. Expected JSON but received: " + 
                        (responseContent.Length > 100 ? responseContent.Substring(0, 100) + "..." : responseContent));
                }

                // Parse response
                var result = JsonConvert.DeserializeObject<LoginResponse>(responseContent);

                return result?.ok ?? false;
            }
            catch (JsonException ex)
            {
                throw new Exception("Failed to parse server response. The server may be down or returning an error page.", ex);
            }
        }

        private void SetControlsEnabled(bool enabled)
        {
            txtUsername.Enabled = enabled;
            txtPassword.Enabled = enabled;
            btnLogin.Enabled = enabled;
            btnCancel.Enabled = enabled;
        }

        private void btnCancel_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Are you sure you want to exit?", 
                "Confirm Exit", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                Application.Exit();
            }
        }

        private void txtPassword_KeyPress(object sender, KeyPressEventArgs e)
        {
            // Allow Enter key to submit
            if (e.KeyChar == (char)Keys.Enter)
            {
                e.Handled = true;
                btnLogin_Click(sender, e);
            }
        }

        private void txtUsername_KeyPress(object sender, KeyPressEventArgs e)
        {
            // Allow Enter key to move to password
            if (e.KeyChar == (char)Keys.Enter)
            {
                e.Handled = true;
                txtPassword.Focus();
            }
        }

        private void LoginForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            httpClient?.Dispose();
        }

        private void chkShowPassword_CheckedChanged(object sender, EventArgs e)
        {
            txtPassword.UseSystemPasswordChar = !chkShowPassword.Checked;
        }

        // Response model for JSON deserialization
        private class LoginResponse
        {
            public bool ok { get; set; }
        }
    }
}
